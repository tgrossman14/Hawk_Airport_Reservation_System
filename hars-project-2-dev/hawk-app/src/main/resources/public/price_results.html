<!DOCTYPE html>
<html>
	<head>
	 	<meta charset="UTF-8">
		<title>Proceed to checkout</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.3/css/all.css" integrity="sha384-SZXxX4whJ79/gErwcOYf+zWLeJdY/qpuqC4cAa9rOGUstPomtqpuNWT9wdPEn2fk" crossorigin="anonymous">
		<style>
		li.nav-item{
    		padding: 0 1em;
		    font-size: large;
		}
		
		li.logout{
		    position: absolute;
		    right: 0;
		}
		
		#imgLogo {
			height: 40px;
		}
		
		#airplane {
		  width: 50em;
		  height: 43em;
		  position: fixed;
		}
		
		#formRow {
		  margin-top: 5em;
		}
		
		#formNav {
		  border-bottom: 1px solid #044ea0;
		  padding-bottom: 1em;
		}
		
		#button {
		  float: right;
		  margin-bottom: 2em;
		  margin-top: 2em;
		}
		
		.resultCards {
			margin-top: 1em;
		}
		
		#resultsHeader {
			text-align: center;
			font-weight: 600;
			margin-top: 1em;
		}
		
		.card-title {
			margin-top: 0.5em;
			font-weight: 600;
		}
		
		.card-header {
			background-color: #044ea0;
			height: 3.5em;
		}
		
		.cardHeader {
			color: white;
			margin-top: 5px;
			font-weight: 600;
			margin-left: 1em;
		}
		
		.departingDiv {
			border: solid 1px grey;
			border-radius: 5px;
		}
		
		.fromIata {
			float: left;
			margin-left: 0.5em;
			margin-top: 0.5em;
			display: inline-block;
		}
		
		.ariveIata {
			float: right;
			margin-right: 0.5em;
			margin-top: 0.5em;
			display: inline-block;
		}
		
		.fas {
			color: #f1726b;
		}
		
		hr {
			display: inline-block;
			width: 13em;
			color: #f1726b;
		}
		
		.rowIn {
			margin: auto;
			width: 97%;
		}
		
		.carInfo {
			font-weight: 600;
		}
		
		.col-6 {
			margin-bottom: 1em;
		}
		
		.departInfo {
			border-right: 1px #044ea0 solid;
		}
		
		.arriveInfo {
			border-left: 1px #044ea0 solid;
		}
		
		.departBody {
			margin-top: 1em;
		}
		
		.flightRadio {
			color: #f1726b;
			float: right;
			margin-bottom: 2em;
		}
		
		.grandTotal {
			font-weight: 600;
			float: right;
			margin-top: 1em;
			color: #f1726b;
		}
		
		.conn {
			margin-top: 3px;
		}
		
		#checkout {
			color: #044ea0;
			font-weight: 800;
			margin-top: 5px;
			float: left;
		}
		
		.text-center {
			margin-top: 2em;
		}
		
		.col-md {
			margin-top: 2em;
		}
		
		.nameOnCard {
			float: left;
			font-weight: 700;
			color: #044ea0;
		}
		
		#backBtn {
			float: left;
			margin-top: 1em;
		}
		
		#confirmBtn {
			float: right;
			margin-right: 25px;
			margin-top: 1em;
		}
		
		.resultCards {
			margin-bottom: 2em;
		}
		
		.col-5, .col-7 {
			margin-top: 2em;
		}
		
		.border-primary {
			max-width: 20rem;
		}
		
		.radioLabels {
			color: #f1726b;
			font-weight: 600;
			margin-left: 0.5em;
			margin-right: 0.5em;
		}
		
		#luggageHeader {
			color: #044ea0;
			margin-top: 1em;
			text-align: center;
			font-weight: 700;
		}

		#luggageDiv {
			float: right;
			width: 50%;
		}

		#passengers {
			margin-top: 1em;
		}
		
		#radioInputs {
			width: 50%;
			margin: auto;
		}
		
		.passHeader {
			font-weight: 700;
			color: white;
			margin-top: 5px;
		}
		
		.nameHeader {
			font-weight: 600;
			color: #044ea0;
			margin-top: 0.5em;
			margin-right: 0.5em;
		}
		
		.firstAndLast {
			width: 100%;
		}

		</style>

	</head>
	<body id="ok">
		<!-- Navbar -->
        <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #044ea0;">
            <div class="container-fluid">
                <a class="navbar-brand" href="#"><img id="imgLogo" src="logo_no_bg.png" alt="hars_logo"></a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/api/dashboard">Current Bookings</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/api/airports">Book New Trip</a>
                        </li>
                        <li class="nav-item logout">
                            <a class="nav-link active" aria-current="page" href="/api/logout">Logout</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
		<div class="container">
	        <div id="formRow" class="row">
	        	       <div id="formNav">
	                    <ul class="nav nav-pills nav-fill">
		                    <li class="nav-item">
	                            <a class="nav-link disabled" aria-current="page" href="#">Destinations</a>
	                        </li>
	                        <li class="nav-item">
	                            <a class="nav-link disabled" aria-current="page" href="#">Search Flights</a>
	                        </li>
	                        <li class="nav-item">
	                            <a class="nav-link disabled" href="#" >Results</a>
	                        </li>
	                        <li class="nav-item">
	                            <a class="nav-link active" href="#" tabindex="-1" aria-disabled="true">Checkout</a>
	                        </li>
	                    </ul>
	                </div>
	            <div class="col-7">
	                <!-- Page Bar -->
	                <!-- Review Card -->
					<div class="card text-center">
					  <div class="card-body">
					  <form id="form" method="POST" action="/api/create-order">
					  <div id="luggageDiv">
					  	<h3 id="luggageHeader">Luggage Size</h3>
					  	<div class="radioInputs">
					  	<input type="radio" name="luggage" value="S" id="S" checked />
						<label class="radioLabels" for="S">Small</label>
						<input type="radio" name="luggage" value="M" id="M" />
			            <label class="radioLabels" for="M">Medium</label>
			            <div class="radioInputs">
			            <input type="radio" name="luggage" value="L" id="L" />
			            <label class="radioLabels" for="L">Large</label>
			            <input type="radio" name="luggage" value="XL" id="XL" />
			            <label class="radioLabels" for="XL">Extra Large</label>
			            </div>
			            <input type="hidden" name="names-json" id="names-json" />
			            </div>
		             </div>
						<div id="passengers"></div>
						
					  	<h4 id="checkout">Checkout</h4>
					  	<div class="input-group input-group-lg row">
							<div class="col-md">
		                        <h5 class="nameOnCard">Name on Card</h5>
		                        <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-lg" id="nameCard" name="nameCard" placeholder="Name on Card">
		                    </div>
	                    </div>
	                    <div class="input-group input-group-lg row mb-3">
		                    <div class="col-md">
		                        <h5 class="nameOnCard">Credit Card Number</h5>
		                        <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-lg" id="numberCard" name="numberCard" placeholder="1111 2222 3333 4444">
		                    </div>
	                    </div>
	                    <div class="input-group input-group-lg row mb-3">
		                    <div class="col-md">
		                        <h5 class="nameOnCard">Expiration Date</h5>
		                        <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-lg" id="expCard" name="expCard" placeholder="MM/YYYY">
		                    </div>
		                     <div class="col-md">
		                        <h5 class="nameOnCard">CVN (Card Verification Number)</h5>
		                        <input type="text" class="form-control" aria-label="Sizing example input" aria-describedby="inputGroup-sizing-lg" id="cvnCard" name="cvnCard" placeholder="123">
		                    </div>
	                    </div>
		                    <button id="backBtn" type="button" class="btn btn-primary btn-lg">Back</button>
						    <button id="confirmBtn" type="submit" class="btn btn-primary btn-lg">Confirm Order</button>
					    </form>
					  </div>
					</div>
	            </div>
	            <!-- Airplane Image -->
	            <div class="col-5">
						<span id="spanFlights">
						</span>
	            </div>
	        </div>
	    </div>
	    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
		<script>
						/* Raymond's Code */
			let spanFlights = document.getElementById("spanFlights");
			let backBtn = document.getElementById("backBtn");
			backBtn.addEventListener("click", function() {
				history.back();
			});
			
			/* Ashar's Code */
			
			var body = document.getElementById("ok");
			var form = document.getElementById("form");
			var button = document.getElementById("button");

			var cookieValue = document.cookie
							  .split('; ')
							  .find(row => row.startsWith('flight='))
							  .split('=')[1];
			var flight_search_offer = JSON.parse(cookieValue);

			console.log(document.cookie);
			var cookieValueFlight = document.cookie
							  .split('; ')
							  .find(row => row.startsWith('flight='))
							  .split('=')[1];
			var flight_search_offer = JSON.parse(cookieValueFlight);
			console.log(flight_search_offer);

			flight_search_offer.disablePricing = true;
			flight_search_offer.paymentCardRequired = false;
			var flight_price_offer = {
				"data": {
					"type": "flight-offers-pricing",
					"flightOffers": [flight_search_offer]
				}
			};
			/* Raymond's Code */
			function createCard() {
			let div1 = document.createElement("div");
					div1.classList.add("card")
					div1.classList.add("text-center")
					div1.classList.add("resultCards")
					
					let div2 = document.createElement("div");
					div2.classList.add("card-header");
					
					let cardHeader = document.createElement("h4");
					cardHeader.classList.add("cardHeader");
					cardHeader.innerHTML = "Flight Order Overview";
					
					div2.appendChild(cardHeader);
					div1.appendChild(div2);
					
					
					let div3 = document.createElement("div");
					div3.classList.add("card-body");
					
					let grand_total = flight_search_offer.price.grandTotal;
					let itineraries = flight_search_offer.itineraries;
					
					for (let itinerary_index in itineraries) {
						let segments = itineraries[itinerary_index].segments;
						let total_duration = itineraries[itinerary_index].duration;
						let departH4 = document.createElement("h4");
						departH4.classList.add("card-title");
						if (itinerary_index == 0) {
							departH4.innerHTML = "Departing Flight";
							div3.appendChild(departH4);			
						} else {
							departH4.innerHTML = "Returning Flight";
							div3.appendChild(departH4);		
						}
						
						
						for (let segment_index in segments) {
							let carrier = segments[segment_index].carrierCode;
							let number = segments[segment_index].number;
							let departure_time = segments[segment_index].departure.at;
							let departure_iata = segments[segment_index].departure.iataCode;
							let arrival_time = segments[segment_index].arrival.at;
							let arrival_iata = segments[segment_index].arrival.iataCode;
							let duration = segments[segment_index].duration;
							
							// Duration Converted
							let newDuration = duration.slice(2);
							let hourIdx = newDuration.indexOf("H");
							let minIdx = newDuration.indexOf("M");
							let hour = newDuration.substring(0, hourIdx);
							let minute = newDuration.substring(hourIdx + 1, minIdx);
							let trueDuration = hour + " " + "Hours and " + minute + " Minutes";
							
							// Departing Converted
							let timeIdx = departure_time.indexOf("T");
							let departDate = departure_time.substring(0, timeIdx);
							let departMilitaryTime = departure_time.substring(timeIdx + 1);
							
							function convertTime(time, date) {
								time = time.split(':');
								let hours = Number(time[0]);
								let minutes = Number(time[1]);
								let seconds = Number(time[2]);
								// calculate
								let timeValue;
								
								if (hours > 0 && hours <= 12) {
								  timeValue= "" + hours;
								} else if (hours > 12) {
								  timeValue= "" + (hours - 12);
								} else if (hours == 0) {
								  timeValue= "12";
								}
								timeValue += (minutes < 10) ? ":0" + minutes : ":" + minutes;  // get minutes
								timeValue += (hours >= 12) ? " P.M." : " A.M."; 
								date = format(date);
								let newTime = date + " at " + timeValue;	
								return newTime;
							}
							
							let newDepart = convertTime(departMilitaryTime, departDate);
							
							// Arival Converted
							let arriveTimeIdx = arrival_time.indexOf("T");
							let arriveDate = arrival_time.substring(0, arriveTimeIdx);
							let arriveMilitaryTime = arrival_time.substring(arriveTimeIdx + 1);
							let newArrive = convertTime(arriveMilitaryTime, arriveDate);
							

							let div4 = document.createElement("div");
							div4.classList.add("departingDiv");
							
							let fromIataH5 = document.createElement("h5");
							fromIataH5.classList.add("fromIata");
							fromIataH5.innerHTML = `${departure_iata} `;
							
							let iconDep = document.createElement("i");
							iconDep.classList.add("fas");
							iconDep.classList.add("fa-plane-departure");
							
							fromIataH5.appendChild(iconDep);
							div4.appendChild(fromIataH5);
							
							let hr = document.createElement("hr");
							div4.appendChild(hr);
							
							let ariveIataH5 = document.createElement("h5");
							ariveIataH5.classList.add("ariveIata");
							
							let iconAr = document.createElement("i");
							iconAr.classList.add("fas");
							iconAr.classList.add("fa-plane-arrival");
							ariveIataH5.innerHTML = `${arrival_iata} `;
							ariveIataH5.appendChild(iconAr);
							div4.appendChild(ariveIataH5);
							
							let carrierH6 = document.createElement("h6");
							carrierH6.classList.add("departBody");
							carrierH6.classList.add("carInfo");
							carrierH6.innerHTML = `Carrier Information: ${carrier}${number}`;
							div4.appendChild(carrierH6);
							
							let durationP = document.createElement("p");
							durationP.classList.add("departBody");
							durationP.innerHTML = `Duration of Flight: ${trueDuration}`;
							div4.appendChild(durationP);
							
							let divRow = document.createElement("div");
							divRow.classList.add("row");
							divRow.classList.add("rowIn");
							
							let div5 = document.createElement("div");
							div5.classList.add("col-6");
							div5.classList.add("departInfo");
							
							let departP = document.createElement("p");
							departP.classList.add("departBody");
							departP.innerHTML = `Departing from ${departure_iata} on ${newDepart}`;
							div5.appendChild(departP);
							divRow.appendChild(div5);
							
							let div6 = document.createElement("div");
							div6.classList.add("col-6");
							div6.classList.add("arriveInfo");
							
							let ariveP = document.createElement("p");
							ariveP.classList.add("departBody");
							ariveP.innerHTML = `Arriving at ${arrival_iata} on ${newArrive}`;
							div6.appendChild(ariveP);
							divRow.appendChild(div6);
							div4.appendChild(divRow);
							div3.appendChild(div4);
							
							let indexCheck = segment_index + 1;
							if(indexCheck < segments.length) {
								let connH5 = document.createElement("h5");
								connH5.classList.add("conn");
								connH5.innerHTML = "Connecting Flight";
								div3.appendChild(connH5);
							}
						}
					}
					let grandH5 = document.createElement("h5");
						grandH5.classList.add("grandTotal");
						grandH5.innerHTML = `Grand Total: $${grand_total}`;
						div3.appendChild(grandH5);
						div1.appendChild(div3);
						spanFlights.appendChild(div1);	
				}
				
			/* Ashar's Code */
			async function FlightOffersPrice() {
				var request_access = await RequestAccessToken();
				
				var url = "https://test.api.amadeus.com/v1/shopping/flight-offers/pricing?forceClass=false";
				var access_token = request_access.access_token;
				var response = await fetch(url, {
					method: 'POST', 
					headers: {
						'Authorization': 'Bearer ' + access_token,
						'Content-Type': 'application/json'
					}, 
					body: JSON.stringify(flight_price_offer)
				});
				var json = await response.json();
				console.log(json);
			}
			
			/* Ashar's Code Dynamic Code for Passangers*/
			var cookieValue = document.cookie
							  .split('=')[1];
			let flight_search_offer2 = JSON.parse(cookieValue);
			flight_search_offer2.disablePricing = true;
			flight_search_offer2.paymentCardRequired = false;
			
			function inputPassengerNames() {
				let pricings = flight_search_offer2.travelerPricings;
				for (let i = 0; i < pricings.length; i++) {
					let cardDiv1 = document.createElement("div");
					cardDiv1.classList.add("card");
					cardDiv1.classList.add("border-primary");
					cardDiv1.classList.add("mb-3");
					
					let cardDiv2 = document.createElement("div");
					cardDiv2.classList.add("card-header");
					let passH4 = document.createElement("h4");
					passH4.innerHTML = "Passenger Name";
					passH4.classList.add("passHeader");
					cardDiv2.appendChild(passH4);
					cardDiv1.appendChild(cardDiv2);
					
					let cardDiv3 = document.createElement("div");
					cardDiv3.classList.add("card-body");
					cardDiv1.appendChild(cardDiv3);
					
					let inputDiv = document.createElement("div");
					inputDiv.classList.add("input-group");
					inputDiv.classList.add("mb-3");
					
					let firstNameHeader = document.createElement("h4");
					firstNameHeader.innerHTML = "First Name";
					firstNameHeader.classList.add("nameHeader");
					
					let lastNameHeader = document.createElement("h4");
					lastNameHeader.innerHTML = "Last Name";
					lastNameHeader.classList.add("nameHeader");
										
					let firstNameInput = document.createElement("input");
					firstNameInput.setAttribute("type", "text");
					firstNameInput.setAttribute("aria-describedby", "inputGroup-sizing-lg");
					firstNameInput.setAttribute("aria-label", "Sizing example input");
					firstNameInput.setAttribute("placeholder", `Passenger ${i+1} First Name`);
					firstNameInput.setAttribute("name", `passenger-${i}-first-name`);
					firstNameInput.setAttribute("id", `passenger-${i}-first-name`);
					let lastNameInput = document.createElement("input");
					lastNameInput.setAttribute("type", "text");
					lastNameInput.setAttribute("placeholder", `Passenger ${i+1} Last Name`);
					lastNameInput.setAttribute("name", `passenger-${i}-last-name`);
					lastNameInput.setAttribute("id", `passenger-${i}-last-name`);
					lastNameInput.classList.add("firstAndLast");
					firstNameInput.classList.add("firstAndLast");
					firstNameInput.classList.add("form-control");
					lastNameInput.classList.add("form-control");
					lastNameHeader.classList.add("col-12");
					firstNameHeader.classList.add("col-12");
					firstNameInput.classList.add("col-12");
					lastNameInput.classList.add("col-12");
					firstNameInput.className = "name col-12 form-control firstAndLast";
					lastNameInput.className = "name col-12 form-control firstAndLast";
					/* form.appendChild(firstNameInput);
					form.appendChild(lastNameInput); */
					inputDiv.appendChild(firstNameHeader);
					inputDiv.appendChild(firstNameInput);
					inputDiv.appendChild(lastNameHeader);
					inputDiv.appendChild(lastNameInput);
					cardDiv3.appendChild(inputDiv);
					let span = document.getElementById("passengers");
					span.appendChild(cardDiv1);
				}
			}
			
			form.onsubmit = function () {
				var kvpairs = [];
                for ( var i = 0; i < form.elements.length; i++ ) {
                   var e = form.elements[i];
                   if (e.className==="name col-12 form-control firstAndLast") {
		             	kvpairs.push(encodeURIComponent(e.name) + "=" + encodeURIComponent(e.value));
		           	}
		       	}
		       	var names = {
					"passengers": [],
					"luggage": "",
					"cabin":""
				};
				for (var i = 0; i < parseInt(kvpairs.length/2); i++) {
					var bothNames = {
						"firstName" : `${kvpairs[2*i].split("=")[1]}`,
						"lastName" : `${kvpairs[2*i + 1].split("=")[1]}`
					};
					names.passengers.push(bothNames);
				}
				var value = document.querySelector('input[name="luggage"]:checked').value;
				names.luggage = value;
				var cabin = flight_search_offer2.travelerPricings[0].fareDetailsBySegment[0].cabin;
				names.cabin = cabin;
				document.getElementById("names-json").setAttribute("value", JSON.stringify(names));
				document.cookie = "flight=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/ SameSite=None; Secure;";
			}
			
			
			function format(inputDate) {
			    var date = new Date(inputDate);
			    if (!isNaN(date.getTime())) {
			        // Months use 0 index.
			        return date.getMonth() + 1 + '/' + date.getDate() + '/' + date.getFullYear();
			    }
			}
			
			async function RequestAccessToken() {
				var request_access = await fetch('https://test.api.amadeus.com/v1/security/oauth2/token', {
				    method: 'POST',
				    body: new URLSearchParams({
				        'grant_type': 'client_credentials',
				        'client_id': 'OGORt5hAGLuW5GzewaxGCPFVNrKiB0WV',
				        'client_secret': 'ik6GIT6Y7ui09KcA'
				    })
				});
				var access_json = await request_access.json();
				return access_json;
			}
			
			window.onload = function() {
				createCard();
				inputPassengerNames();
			};


		</script>
	</body>
</html>
